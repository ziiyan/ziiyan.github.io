---
title: 浏览器缓存
date: 2020-07-21 15:58:33
tags: [ 浏览器, 性能 ]
---

# HTTP 缓存

## 1、缓存的判断策略

### 1.1、存储策略

* 发生在收到请求响应后
* 用于决定是否缓存相应资源

### 1.2、过期策略

* 发生在请求前
* 用于判断缓存是否过期

### 1.3、协商策略

* 发生在请求中
* 用于判断缓存资源是否更新

![img](https://mmbiz.qpic.cn/mmbiz_png/MpGQUHiaib4ib49yrHAQicnnlN8I2aFBFp66xQGD623d7kG6CnZcV1ruWC4wW1lqRLgxFuejMIULiaMicFaZaDtblThQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

浏览器下访问资源的方式主要有以下7种：

1. (新标签)地址栏回车
2. 链接跳转
3. 前进、后退
4. 从收藏栏打开链接
5. (window.open)新开窗口
6. 刷新（Command + R / F5）
7. 强制刷新（Command + Shift + R / Ctrl + F5）

![img](https://mmbiz.qpic.cn/mmbiz_png/MpGQUHiaib4ib49yrHAQicnnlN8I2aFBFp668KIXEzsZ1NDTpYAt9MYu32flx46pkOkD7yRvdwGNIbeUXLG8xG9CmQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



## 2、缓存基础

缓存又分为强缓存和弱缓存（又称为协商缓存），区别是**获取资源时是否会发送请求**。

### 2.1、强缓存

* 包括 Expires 和 Cache-Control
* 过期策略生效时应用的缓存

### 2.2、弱缓存

* 包括 Last-Modified 和 ETag
* 协商策略后应用的缓存

### 2.3、HTTP 相关字段

#### 2.3.1、Expires（1.0）

* 指定缓存的过期时间，为绝对时间
* 响应头字段
* 参考本地时间进行比对，在指定时刻后过期
* 因此修改本地时间就会失效

#### 2.3.2、Cache-Control

* 指定资源的缓存机制
* 同时在请求头和响应头中设定
* 涉及存储策略、过期策略

![img](https://mmbiz.qpic.cn/mmbiz_png/MpGQUHiaib4ib49yrHAQicnnlN8I2aFBFp66uQQMWK9OIiaUL53ttvZQLY7VsXfuE8tnKKMThZ0O3hcbSW6VVX3H3Tw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

##### 2.3.2.1、cache-directive 大小写不敏感

##### 2.3.2.2、在请求头中的 max-age

* `max-age=<seconds>`
* 客户端不接受有效时间大于指定时间的缓存
* Chrome和Firefox浏览器下的刷新操作（Command+ R / F5）均是在请求头上添加了max-age=0指令，表示**不使用强缓存，但允许协商缓存**

##### 2.3.2.3、max-age 优先级高于 Expires

##### 2.3.2.4、no-cache 和 no-store

* no-cache：跳过强缓存，强制进入协商策略
* no-store：不缓存

#### 2.3.3、Pragma（1.0）

* 通常设置为`Pragma:no-cache`，作用与`Cache-Control:no-cache`相同
* 当在浏览器进行强刷（Comand + Shift + R / Ctrl + F5）或在NetWork面板内勾选禁用缓存（Disable Caches）时，会自动带上`Pragma:no-cache`和`Cache-Control:no-cache`，**并且不会带上协商策略中所涉及的信息（下面介绍的If-Modified-Since/If-None-Match）**。这时不会使用任何缓存，重新获取资源

#### 2.3.4、Last-Modified / If-Modified-Since / If-Unmodified-Since

* `Last-Modified`用于标记请求资源的最后一次修改时间
* 返回的资源带有`Last-Modified`标识时，再次请求该资源，浏览器会自动带上`If-Modified-Since`，值为返回的`Last-Modified`值
* 请求到达服务器后，服务器进行判断，如果从上次更新后没有再更新，则返回304。如果更新了则重新返回
* `If-Modified-Since` 只能用于 GET、HEAD
* `If-Unmodified-Since` 表示资源未修改则正常执行更新，否则返回412

#### 2.3.5、ETag / If-Match / If-None-Match

* ETag是请求资源在服务器的唯一标识，浏览器可以根据ETag值缓存数据
* 再次请求时通过 If-None-Match 携带上次的 ETag 值
	* 如果值不变，则返回304
	* 如果改变则返回新的内容

* **ETag的优先级高于Last-Modified**

## 3、缓存的优缺点

![image-20200721172953127](/Users/wuziyan/Library/Application Support/typora-user-images/image-20200721172953127.png)

# 浏览器缓存

# 应用程序缓存