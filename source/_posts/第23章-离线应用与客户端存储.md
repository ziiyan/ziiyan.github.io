---
title: 第二十三章 离线应用与客户端存储
date: 2020-03-14 17:27:55
tags: JavaScript高级程序设计
---

# 第二十三章 离线应用与客户端存储

离线 Web 应用：设备不能上网的情况下仍然可以运行的应用



## 离线检测

* `navigator.onLine` 属性



* 应用缓存



## 应用缓存

* appache 从浏览器的缓存中分出一块缓存区
	* 使用一个**描述文件(manifest file)**，列出要下载和缓存的资源
	* 将描述文件与页面关联起来，可以在 `html` 中的 `manifest` 属性指定文件路径
* applicationCache 对象



## 数据存储

### HTTP Cookie

* 要求服务器对任意 HTTP 请求发送 Set-Cookie HTTP 作为响应的一部分，其中包含会话信息

> 如：
>
> HTTP/1.1 200 OK
>
> Content-type: text / html
>
> Set-Cookie: name = value
>
> Other-header: other-header-value

* 限制

	* Cookie 在性质上是绑定在特定的域名下的
	* 当设定了一个 cookie 后，再给创建它的域名发送请求时，都会包含这个 cookie
	* 确保 cookie 中的信息只能让批准的接受者访问，而无法被其他域访问

* 构成

	* 名称：不区分大小写（实践最好区分），经过 URL 编码
	* 值：URL 编码
	* 域：有效域
	* 路径：对于指定的路径，应该向服务器发送 cookie
		* 若指定 http://www.wrox.com/books/，就不会给 http://www.wrox.com 发送 cookie
	* 失效时间：cookie 何时应该被删除的时间戳
	* 安全标志：指定后之后 SSL 连接时才发送到服务器

* JS 中的 cookie

	* BOM 的 document.cookie 属性

* 子 cookie

	* 存放在单个 cookie 中的更小段的数据

	* 使用 cookie 值来存储多个名称值对

	* > 如 name=name1=value1&name2=value2&name3=value3&name4=value4&name5=value5

	* 查询字符串的格式进行格式化



> 所有的 cookie 都会由浏览器作为请求头发送，所以在 cookie 中存储大量信息会影响到特定域的请求性能



### Web 存储机制

* Web Storage 的两个主要目标
	* 提供一种在 cookie 之外存储会话数据的途径
	* 提供一种存储大量可以跨会话存在的数据的机制



##### Storage 类型

* 只能存储字符串
* 提供最大的存储空间
* `clear()`
* `getItem(name)`
* `key(index)`
* `removeItem(name)`
* `setItem(name, value)`

##### sessionStorage 对象

*  Storage 的一个实例
* 存储特定于某个会话的数据，只保持到浏览器关闭
	* 如果浏览器支持，崩溃重启可以继续使用
* 可以跨越页面刷新而存在
* 存储在 sessionStorage 的数据只能由最初给对象存储数据的页面访问到，所以对多页面应用有限制

##### globalStorage 对象

* 不是 Storage 实例，globalStorage["xxx.com"] 才是 Storage 的实例
* 跨越会话存储数据，有特定的访问限制
* 如果不删除，或者用户未清除浏览器缓存，存储在 globalStorage 属性中的数据会一直保留在磁盘上
* 合在客户端存储文档或者长期保存用户偏好设置

##### localStorage 对象

* Storage 实例，用法与 sessionStorage 相同
* 取代 globalStorage，不用设置规则
* 同域名、同协议、同端口
* 保留到通过 JavaScript 删除或者是用户清除浏览器缓存

##### storage 事件

* 修改 Storage 对象会在文档上触发 storage 事件



### IndexedDB

* 浏览器中保存结构化数据的一种数据库
* 替代被废弃的 Web SQL Database API
* 创建一套 API，方便保存和读取 JavaScript 对象，同时还支持查询及搜索
* 异步
* 做为全局对象 windows.indexedDB，具体名称根据浏览器不同



##### 数据库

* 用对象保存数据，而不是用表来保存
* 一个 IndexedDB 数据库，就是一组位于相同命名空间下的对象的集合
* indexDB.open() 创建/打开
* 返回 IDBRequest 对象
	* onerror
	* onsuccess

##### 对象存储空间

* 可以把这里的对象存储空间(object storge)想象成表，把其中保存的对象想象成表中的记录
* `add()`
* `put()`

##### 事务

* 读取或修改数据都要通过事务来组织所有操作
* 使用事务可以直接通过已知的键检索单个对象

##### 使用游标查询

* 需要检索多个对象的情况下，需要在事务内 部创建游标
* 与传统数据库查询不同
	* 游标不提前收集结果
	* 游标指针会先指向结果中的第一项，在接到查找下一项的指令时指向下一项

##### 键范围

##### 设定游标方向
