---
title: 学习笔记：浏览器工作原理
date: 2020-08-16 21:16:51
tags: [ 浏览器 ]
---

## 浏览器结构图

<img src="/Users/wuziyan/Library/Application Support/typora-user-images/image-20200816214321080.png" alt="image-20200816214321080" style="zoom:50%;" />

* 用户界面：展示除标签页窗口之外的其他用户界面内容
* **渲染引擎（浏览器内核）**：渲染用户请求的页面内容
* 浏览器引擎：用户界面和渲染引擎之间传递数据
* 网络模块：负责网络请求
* js 解释器：解析和执行 js
* 数据持久层：存储各种数据

## 进程 / 线程

* 进程
	* 操作系统进行资源分配和调度的基本单元
	* 可以申请和拥有计算机资源，进程是程序的基本执行实体
* 线程
	* 操作系统能够进行运算调度的最小单位
	* 一个进程中可以并发多个线程，每条线程并行执行不同的任务

### 多进程浏览器结构

* 浏览器进程：控制除标签页外的用户界面（包括地址栏、书签、后退和前进按钮，负责与浏览器的其他进程协调工作）
* 网络进程：发起接收网络请求
* GPU 进程：整个浏览器界面的渲染
* 插件进程：控制网站使用的所有插件（flash）
* **渲染器进程**：控制显示 tab 标签内的所有内容

## 地址栏输入地址到页面展示

* **浏览器进程**的 UI 线程捕捉输入内容
* 网络线程请求 DNS 进行域名解析，向服务器发起请求
* 获取到数据后通过 SafeBrowsing 检查站点是否是恶意站点
* **渲染器进程**渲染页面
* 主线程解析 html，构造 DOM 数据结构
* 主线程解析 CSS，确定每个 DOM 节点的计算样式
	* Computed Style 样式计算阶段
* 主线程遍历 DOM 和样式生成 Layout Tree
	* Layout 布局阶段
	* Layout Tree 节点记录坐标和边框尺寸
	* Layout Tree 和最后展示在屏幕上的节点一样
		* `display: none` 的节点会在 dom tree 但不在 layout tree
* 主线程遍历 Layout Tree 生成绘制顺序表
	* 绘制阶段（paint）
	* 受到 z-index 影响
* 主线程遍历 Layout Tree 生成 Layer Tree
* 主线程将 绘制顺序表和 Layer Tree 传给合成器线程
* 合成器线程将每个图层切割分给多个栅格化线程（Taster Thread）
* 栅格化线程将结果保存在 GPU
* 合成器线程收集栅格结果，生成合成器帧
* **浏览器进程**将合成器帧传送给 GPU
* GPU 渲染展示到屏幕

## 重排 / 重绘

* 重排
	* 改变尺寸位置属性
	* 重新进行样式计算（computed style）、布局（Layout）、绘制（paint）以及之后的所有流程
* 重绘
	* 改变颜色属性
	* 重新进行样式计算（computed style）、绘制（paint）以及之后的所有流程
* 重排和重绘都会占用主线程，JS 也在主线程，会抢占
* 合成器线程和栅格线程不会和 JS 发生冲突
	* Transform 属性不经过布局和绘制，节省运算时间
* 重排比重绘多一个 布局 Layout 过程

