---
title: 第十三章 事件
date: 2020-03-05 00:52:46
tags: JavaScript高级程序设计
---
# 第十三章 事件
js 和 html 之间的交互是通过**事件**实现的，事件就是文档或浏览器窗口中发生的一些特定的交互瞬间。
可以使用**侦听器**来预定事件，以便事件发生时执行相应的代码。
这种在传统软件工程中被称为**观察员模式**的模型，支持 js 和 html+css 之间的松散耦合。

## 事件流
**事件流**描述的是从页面中接收事件的顺序

### 事件冒泡
按照 DOM 树逐级向上，在每一级节点上都会发生，直到 document

### 事件捕获
顺序与事件冒泡相反

### DOM 事件流
“DOM2 级事件”规定的事件流包括三个阶段：

* 事件捕获阶段
    * Document 到 目标元素的上一级
* 处于目标阶段
    * 事件在目标元素上发生，事件处理被看成冒泡的一部分
* 事件冒泡阶段
    * 目标元素 到 Document
> DOM2 规定捕获阶段不设计目标，但浏览器实现时都会出发事件对象上的事件

## 事件处理程序
* **事件**就是某种动作，如 click、load、mouseovre
* **事件处理程序（事件侦听器）**就是响应事件的函数，以 on 开头，onclick、onload 等

### HTML 事件处理程序
```html
<input onclick="showMessage()">
<script>
    function showMessage() {……}
</script>
```
* 如果用户在页面解析事件处理程序之前点击元素，会引发错误
* 扩展作用域链在不同浏览器中会导致不同结果
* HTML 与 JavaScript 代码紧密耦合

### DOM0 级事件处理程序
将一个函数赋值给事件处理程序属性
```js
var btn = document.getElementById("myBtn");
btn.onclick = function () {……}
```

* 代码运行之前不会指定事件处理程序，可能导致点击无效
* 事件处理程序是在元素的作用域中运行的，this 引用当前元素
* null 即删除

### DOM2 级事件处理程序
* `addEventListener(a, b, c)`
* `removeEventListener(a, b, c)`
    * a 要处理的事件名
    * b 作为事件处理程序的函数
    * c 一个布尔值
        * true 捕获阶段调用事件处理程序
        * false 冒泡阶段调用事件处理程序 ☑️
```js
var btn = document.getElementById("myBtn");
btn.addEventListener("click", function() {}, false}
```

* 事件处理程序是在元素的作用域中运行的，this 引用当前元素
* 存在多个事件处理程序会按照添加顺序触发
* addEventListener()添加的事件处理程序只能使用 removeEventListener()来移除
* addEventListener() 添加的匿名函数无法移除

### IE 事件处理程序
* `attachEvent(a, b)`
* `detachEvent(a, b)`
    * a 事件处理程序名称
    * b 事件处理程序函数

* 只支持冒泡
* 事件处理程序的作用域是全局
* 存在多个事件处理程序会按照添加顺序相反的顺序触发

### 跨浏览器的事件处理程序
关注冒泡阶段

* `addHandler(a, b, c)`
* `EventUtil(a, b, c)`
    * a 要操作的元素
    * b 事件名称
    * c 事件处理程序

## 事件对象
在触发 DOM 上的某个事件时，会产生一个事件对象 event，这个对象中包含着所有与时间有关的信息

### DOM 中的事件对象
兼容 DOM 的浏览器会将一个 event 对象传入到事件处理程序中

* `event.preventDefault()` 阻止特定事件的默认行为，如链接到默认行为是导航到 href
* `event.stopPropagation()` 停止事件在 DOM 层次中的传播（捕获或冒泡）
* `event.eventPhase` 确定事件当前正位于事件流的哪个阶段
    * 捕获 1
    * 处于目标 2
    * 冒泡 3
* 事件处理器执行期间 event 对象才会存在，执行完就销毁

### IE 中的事件对象
### 跨浏览器的事件对象

## 事件类型
### UI事件
不一定与用户操作有关

* `load` 当页面完全加载后在 window 上触发，当图像加载完毕时在<img>元素上面触发
* `unload` 当页面完全卸载后在 window 上触发（页面切换时）
* `resize` 浏览器窗口调整大小时 window 上触发，通过 js 或 body 元素中 onresize 指定事件处理程序
* `scroll` window 对象上发生，表示页面中相应元素的变化

### 焦点事件
获得或失去焦点时触发

* `document.hasFocus()`
* `document.activeElement`

---
* `blur` 元素失去焦点时触发，不冒泡
* `focus` 获得焦点时触发，不冒泡
* `focusin` 获得焦点时，冒泡
* `focusout` 失去焦点时，冒泡

### 鼠标与滚轮事件
* `click` 单击或回车
* `dblclick` 双击
* `mousedown` 按下任意鼠标按钮
* `mouseup` 释放鼠标按钮
* `mouseenter` 光标从外部首次移动到元素范围之内，不冒泡，移动到后代元素上不会触发
* `mouseleave` 元素上的光标移动到元素范围之外，不冒泡，移动到后代元素不触发
* `mousemove` 光标在元素内部移动时重复触发
* `mouseout` 鼠标位于一个元素上方，移入另一个元素时触发。另一个元素可能是原来元素的外部或子元素
* `mouseover` 光标位于一个元素外部，首次移入另一个元素边界之内

---
* 客户区坐标位置
    * `event.clientX`
    * `event.clientY`
* 页面坐标位置
    * `event.pageX`
    * `event.pageY`
* 屏幕坐标位置
    * `event.screenX`
    * `event.screenY`
* 修改键
    * click + 键盘 -> 属性（Boolean）
        * Shift `shiftKey`
        * Ctrl `ctrlKey`
        * Alt `altKey`
        * Meta(Windows/Cmd) `metaKey`
* 相关元素
    * 针对 `moseover`、`mouseout`
        * `relatedTarget` 属性
* 鼠标按钮
    * 针对 `mousedown`、`mouseup`
        * `button` 属性
            * 0 主鼠标
            * 1 滚轮
            * 2 次鼠标
* 鼠标滚轮事件
    * `mousewheel`
        * 冒泡
        * `wheelDelta` 属性

### 键盘与文本事件
* `keydown` 任意键
* `keypress` 字符键
* `keyup` 释放案件

---
* `event.keyCode` 键码，ASCII 小写字母相同
* `event.charCode` 字符编码，针对 keypress

### 变动事件
* 删除节点
* 插入节点

### HTML5 事件
* `contextmenu` 冒泡
* `beforeunload`
* `DOMContentLoaded`
* `readystatechange`
    * uninitialized
    * loading
    * loaded
    * interactive
    * complete
* `pageshow` `pagehide`
* `hashchange`

### 设备事件
智能手机和平板电脑
### 触摸与手势

## 内存和性能
添加到页面上 的事件处理程序数量将直接关系到页面的整体运行性能

* 函数对象占用内存
* 指定事件处理程序导致的 DOM 访问

### 事件委托
利用事件冒泡，只指定一个事件处理程序

### 移除事件处理程序
将事件处理程序指定给元素时，运行中的浏览器代码与支持页面交互的 JavaScript 代码之间就 会建立一个连接。连接越多，页面执行起来就越慢。

## 模拟事件
js 触发事件

### DOM 中的事件模拟
* `document.createEvent()`
    * UIEvents
    * MouseEvents
    * MutationsEvents
    * HTMLEvents

* 模拟鼠标
* 模拟键盘
* 模拟其他

### IE 中
